# =============================================================================
# Matchbook Docker Compose - Production
# =============================================================================
#
# This configuration is optimized for production deployments.
# It assumes external PostgreSQL and Redis services.
#
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#
# Required environment variables:
#   - DATABASE_URL: PostgreSQL connection string
#   - REDIS_URL: Redis connection string
#   - GEYSER_ENDPOINT: Geyser gRPC endpoint
#   - GEYSER_X_TOKEN: Geyser authentication token
#   - SOLANA_RPC_URL: Solana RPC endpoint
#   - CRANK_KEYPAIR: Base58 encoded crank keypair
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Application Services
  # ---------------------------------------------------------------------------

  indexer:
    image: ${REGISTRY:-ghcr.io/joaquinbejar}/matchbook-indexer:${VERSION:-latest}
    container_name: matchbook-indexer
    environment:
      RUST_LOG: ${RUST_LOG:-info,matchbook=debug}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      GEYSER_ENDPOINT: ${GEYSER_ENDPOINT}
      GEYSER_X_TOKEN: ${GEYSER_X_TOKEN}
      SOLANA_RPC_URL: ${SOLANA_RPC_URL}
    ports:
      - "9090:9090"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    networks:
      - matchbook-network

  api:
    image: ${REGISTRY:-ghcr.io/joaquinbejar}/matchbook-api:${VERSION:-latest}
    container_name: matchbook-api
    environment:
      RUST_LOG: ${RUST_LOG:-info,matchbook=debug}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      API_HOST: 0.0.0.0
      API_PORT: 8080
      WS_PORT: 8081
    ports:
      - "8080:8080"
      - "8081:8081"
    deploy:
      replicas: ${API_REPLICAS:-2}
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    networks:
      - matchbook-network

  crank:
    image: ${REGISTRY:-ghcr.io/joaquinbejar}/matchbook-crank:${VERSION:-latest}
    container_name: matchbook-crank
    environment:
      RUST_LOG: ${RUST_LOG:-info,matchbook=debug}
      SOLANA_RPC_URL: ${SOLANA_RPC_URL}
      CRANK_KEYPAIR: ${CRANK_KEYPAIR}
      MIN_PROFIT_LAMPORTS: ${MIN_PROFIT_LAMPORTS:-5000}
      MAX_MATCHES_PER_TX: ${MAX_MATCHES_PER_TX:-8}
    ports:
      - "9091:9091"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    networks:
      - matchbook-network

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------

networks:
  matchbook-network:
    driver: bridge
