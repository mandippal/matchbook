# Matchbook alerting rules
groups:
  - name: matchbook-indexer
    rules:
      - alert: IndexerSlotLagHigh
        expr: indexer_slot_lag > 10
        for: 2m
        labels:
          severity: warning
          service: indexer
        annotations:
          summary: "Indexer slot lag is high"
          description: "Indexer is {{ $value }} slots behind the tip"

      - alert: IndexerSlotLagCritical
        expr: indexer_slot_lag > 50
        for: 1m
        labels:
          severity: critical
          service: indexer
        annotations:
          summary: "Indexer slot lag is critical"
          description: "Indexer is {{ $value }} slots behind. Market data may be stale."

      - alert: IndexerParseErrorsHigh
        expr: rate(indexer_parse_errors_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          service: indexer
        annotations:
          summary: "Indexer parse error rate is high"
          description: "{{ $value | printf \"%.2f\" }} parse errors per second"

      - alert: IndexerDown
        expr: up{job="indexer"} == 0
        for: 1m
        labels:
          severity: critical
          service: indexer
        annotations:
          summary: "Indexer is down"
          description: "Indexer service is not responding"

  - name: matchbook-api
    rules:
      - alert: APIHighLatency
        expr: histogram_quantile(0.99, rate(api_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "API latency is high"
          description: "99th percentile latency is {{ $value | printf \"%.3f\" }}s"

      - alert: APIHighErrorRate
        expr: |
          sum(rate(api_requests_total{status=~"5.."}[5m])) 
          / sum(rate(api_requests_total[5m])) > 0.01
        for: 5m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "API error rate is high"
          description: "Error rate is {{ $value | humanizePercentage }}"

      - alert: APIDown
        expr: up{job="api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "API is down"
          description: "API service is not responding"

      - alert: APIHighConnectionCount
        expr: api_active_connections > 1000
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "High number of API connections"
          description: "{{ $value }} active connections"

  - name: matchbook-crank
    rules:
      - alert: CrankHighFailureRate
        expr: |
          rate(crank_transactions_total{status="failed"}[5m]) 
          / rate(crank_transactions_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: crank
        annotations:
          summary: "Crank failure rate is high"
          description: "{{ $value | humanizePercentage }} of crank transactions are failing"

      - alert: CrankDown
        expr: up{job="crank"} == 0
        for: 1m
        labels:
          severity: critical
          service: crank
        annotations:
          summary: "Crank is down"
          description: "Crank service is not responding"

      - alert: CrankLowProfitability
        expr: crank_profit_lamports < 0
        for: 10m
        labels:
          severity: warning
          service: crank
        annotations:
          summary: "Crank is not profitable"
          description: "Crank profit is {{ $value }} lamports"

  - name: matchbook-websocket
    rules:
      - alert: WebSocketHighConnectionCount
        expr: ws_active_connections > 5000
        for: 5m
        labels:
          severity: warning
          service: websocket
        annotations:
          summary: "High number of WebSocket connections"
          description: "{{ $value }} active WebSocket connections"

      - alert: WebSocketMessageBacklog
        expr: ws_message_queue_size > 10000
        for: 2m
        labels:
          severity: warning
          service: websocket
        annotations:
          summary: "WebSocket message backlog"
          description: "{{ $value }} messages in queue"

  - name: matchbook-infrastructure
    rules:
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanizePercentage }}"

      - alert: HighCPUUsage
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value | printf \"%.1f\" }}%"

      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Disk space is low"
          description: "Only {{ $value | humanizePercentage }} disk space remaining"
