# Recording rules for pre-computed aggregations
groups:
  - name: matchbook-recording
    interval: 30s
    rules:
      # API request rate by endpoint
      - record: api:request_rate:5m
        expr: sum(rate(api_requests_total[5m])) by (method, path)

      # API error rate
      - record: api:error_rate:5m
        expr: |
          sum(rate(api_requests_total{status=~"5.."}[5m])) 
          / sum(rate(api_requests_total[5m]))

      # API latency percentiles
      - record: api:latency_p50:5m
        expr: histogram_quantile(0.50, sum(rate(api_request_duration_seconds_bucket[5m])) by (le))

      - record: api:latency_p95:5m
        expr: histogram_quantile(0.95, sum(rate(api_request_duration_seconds_bucket[5m])) by (le))

      - record: api:latency_p99:5m
        expr: histogram_quantile(0.99, sum(rate(api_request_duration_seconds_bucket[5m])) by (le))

      # Indexer throughput
      - record: indexer:events_per_second:5m
        expr: sum(rate(indexer_events_processed_total[5m]))

      - record: indexer:accounts_per_second:5m
        expr: sum(rate(indexer_accounts_processed_total[5m]))

      # Crank performance
      - record: crank:matches_per_minute:5m
        expr: sum(rate(crank_matches_executed_total[5m])) * 60

      - record: crank:success_rate:5m
        expr: |
          sum(rate(crank_transactions_total{status="success"}[5m])) 
          / sum(rate(crank_transactions_total[5m]))

      # WebSocket metrics
      - record: ws:messages_per_second:5m
        expr: sum(rate(ws_messages_sent_total[5m]))

      - record: ws:connections:current
        expr: sum(ws_active_connections)

      # Market metrics
      - record: market:volume_24h
        expr: sum(increase(market_volume_total[24h])) by (market)

      - record: market:trades_24h
        expr: sum(increase(market_trades_total[24h])) by (market)
